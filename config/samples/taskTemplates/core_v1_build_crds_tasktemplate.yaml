apiVersion: core.michaelhenkel/v1
kind: TaskTemplate
metadata:
  name: build-crds
spec:
  tasks:
    build:
      env:
        GOPATH: /root/go
        GOCACHE: /mnt/buildcache/.cache/go-build
        GOPKGCACHE: /mnt/buildcache/pkg
        REPOPATH: /root/go/src/ssd-git.juniper.net/contrail/cn2
        GOPROXY: https://svl-artifactory.juniper.net/artifactory/api/go/go,direct
      cmds:
      - if [ ! -d "${GOCACHE}" ]; then mkdir -p ${GOCACHE}; fi
      - if [ ! -d "${GOPKGCACHE}" ]; then mkdir -p ${GOPKGCACHE}; fi
      - if [ ! -d "/mnt/builder/${PodNamespace}/${Plan}/${Branch}/out" ]; then mkdir -p /mnt/builder/${PodNamespace}/${Plan}/${Branch}/out; fi
      - if [ ! -d "${REPOPATH}" ]; then mkdir -p ${REPOPATH}; fi
      - ln -s ${GOPKGCACHE} /root/go/pkg
      - cp /mnt/builder/${PodNamespace}/${Plan}/${Branch}/archive.tar.gz /archive.tar.gz
      - tar -C ${REPOPATH} --strip-components 1 -zxf /archive.tar.gz
      - cd ${REPOPATH}/deployer; ${GOPATH}/bin/controller-gen crd:trivialVersions=true,preserveUnknownFields=false paths="./pkg/apis/controlplane/v1alpha1/..." paths="./pkg/apis/configplane/v1alpha1/..." paths="./pkg/apis/dataplane/v1alpha1/..." output:crd:artifacts:config=config/crd/bases
      - cp -r /usr/local/bin/kubectl /usr/local/bin/kustomize ${REPOPATH}/deployer/config/crd /mnt/builder/${PodNamespace}/${Plan}/${Branch}/out
      sources:
      - "${REPOPATH}/deployer/pkg/apis/**/*.go"
      generates:
      - /mnt/builder/${PodNamespace}/${Plan}/${Branch}/out/crd/**
  container:
    name: build-crds
    image: registry.default.svc.cluster1.local:5000/crdloader-builder
    command: ["sh","-c","cp /var/task/task /mnt/builder/${PodNamespace}/${Plan}/crdloader-task.yaml; task -t /mnt/builder/${PodNamespace}/${Plan}/crdloader-task.yaml build"]
    #command: ["sh","-c", "while true; do sleep 10;done"]
  


